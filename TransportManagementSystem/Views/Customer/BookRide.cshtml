@model TransportManagementSystem.Models.ViewModels.BookingViewModel

@{
    ViewData["Title"] = "Book Ride";
}

<div class="container mt-5">
    <h2 class="mb-4">Book Ride</h2>

    <form method="post" asp-action="ConfirmBooking">

        <!-- Pickup -->
        <div class="mb-3">
            <label class="form-label">Pickup Location</label>
            <input asp-for="Source" class="form-control" id="source" required />
        </div>

        <!-- Drop -->
        <div class="mb-3">
            <label class="form-label">Drop Location</label>
            <input asp-for="Destination" class="form-control" id="destination" required />
        </div>

        <!-- Vehicle Category -->
        @* <div class="mb-3">
            <label class="form-label">Select Vehicle Category</label>
            <select asp-for="VehicleTypeId" class="form-control" id="vehicleTypeId" required>
                <option value="">Select Category</option>
                @foreach (var type in Model.VehicleTypes)
                {
                    <option value="@type.Value">@type.Text</option>
                }
            </select>
            <small class="text-muted">
                Base fare and per km rate are shown beside each category.
            </small>
        </div> *@

        <!-- Specific Vehicle -->
        <div class="mb-3">
            <label class="form-label">Select Vehicle</label>
            <select asp-for="VehicleId" class="form-control" id="vehicleSelect" required>
                <option value="">Select Vehicle</option>
            </select>
        </div>

        <!-- Check Fare -->
        <button type="button" class="btn btn-primary mb-3" onclick="checkFare()">
            Check Fare
        </button>

        <!-- Result Box -->
        <div id="result" style="display:none;" class="alert alert-info">
            <p><strong>Distance:</strong> <span id="distanceText"></span> km</p>
            <p><strong>Estimated Fare:</strong> ₹<span id="fareText"></span></p>
        </div>

        <!-- Book -->
        <button type="submit" class="btn btn-success">
            Book Ride
        </button>

    </form>
</div>

@section Scripts {
    <script>

        document.addEventListener("DOMContentLoaded", function () {

            // LOAD ALL VEHICLES ON PAGE LOAD
            fetch('/Customer/GetAllAvailableVehicles')
                .then(response => response.json())
                .then(data => {

                    var vehicleDropdown = document.getElementById("vehicleSelect");
                    vehicleDropdown.innerHTML = '<option value="">Select Vehicle</option>';

                    data.forEach(function (vehicle) {
                        var option = document.createElement("option");
                        option.value = vehicle.vehicleId;
                        option.text = vehicle.modelName;
                        vehicleDropdown.appendChild(option);
                    });
                });

        });


        function checkFare() {

            var source = document.getElementById("source").value;
            var destination = document.getElementById("destination").value;
            var vehicleId = document.getElementById("vehicleSelect").value;

            if (!source || !destination || !vehicleId) {
                alert("Please fill all fields.");
                return;
            }

            fetch('/Customer/GetEstimatedFare?source=' + source +
                  '&destination=' + destination +
                  '&vehicleId=' + vehicleId,
            {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {

                if (data.error) {
                    alert(data.error);
                    return;
                }

                document.getElementById("distanceText").innerText = data.distance.toFixed(2);
                document.getElementById("fareText").innerText = data.fare.toFixed(2);

                document.getElementById("result").style.display = "block";
            });
        }

    </script>
}

